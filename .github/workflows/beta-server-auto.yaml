on:
  push:
    branches:
      - staging
    paths:
      - 'server/**'

name: ğŸ§ª BETA | Server | Auto
jobs:
  server-deploy:
    name: ğŸ‰ Deploy Server
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“© Check Out Code
        uses: actions/checkout@v4.1.1

      - name: ğŸ“ Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.17.1

      - name: ğŸ¥· Use Node.js 20.18.1
        uses: actions/setup-node@v6
        with:
          node-version: '20.18.1'
          cache: 'pnpm'

      - name: ğŸš§ Install Deps
        run: pnpm i --frozen-lockfile --prefer-offline

      - name: ğŸ§¹ Lint Build  (SERV)
        run: pnpm --filter server lint
        working-directory: server

      # TODO:                 Add tests

      # NOTE:                 Build takes place on the box. This is purely for testing.
      - name: ğŸ”¨ Build Project  (SERV)
        run: pnpm --filter server build:staging
        env:
          DB_PORT: 3306
          DB_USERNAME: ${{ secrets.staging_db_user }}
          DB_PASSWORD: ${{ secrets.staging_db_pass }}
          DB_DATABASE: ${{ secrets.staging_db_database }}
          DB_HOST: ${{secrets.staging_db_host}}
          DB_PREFIX: ${{ secrets.staging_db_prefix }}
          DB_TEST: ${{ secrets.staging_db_test }}
        working-directory: server

    # NOTE:                 Disabled temporarily for development
    # - name:               ğŸ“‚ Sync Server
    #   uses:               SamKirkland/FTP-Deploy-Action@4.1.0
    #   with:
    #     password:         ${{ secrets.server_ftppass_staging }}
    #     server:           ${{ secrets.server_ftpserver_staging }}
    #     username:         ${{ secrets.server_ftpuser_staging }}
    #     local-dir:        ./server/
    #     server-dir:       list-api-staging.quickdash.co.uk/app/
    #     exclude:          "[**/.git*/**, **/node_modules/**, **/dist/]"
