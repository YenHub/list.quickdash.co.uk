name: 🧪 BETA | Server | Manual
on: [workflow_dispatch]

jobs:
  server-deploy:
    name: 🎉 Deploy Server
    runs-on: ubuntu-latest
    steps:
      - name: 🚚 Get latest code
        uses: actions/checkout@v2.3.2

      - name: 🐱‍👤 Use Node.js 14.17.1
        uses: actions/setup-node@v2-beta
        with:
          node-version: "14.17.1"

      - name: 💥 Install & Cache Deps (SERV)
        uses: bahmutov/npm-install@v1.4.5
        with:
          working-directory: server

      - name: 🧹 Lint Build  (SERV)
        run: npm run lint
        working-directory: server

      # NOTE:                 Build takes place on the box. This is purely for testing.
      - name: 🔨 Build Project  (SERV)
        run: npm run build:staging
        env:
          DB_PORT: 3306
          DB_USERNAME: ${{ secrets.staging_db_user }}
          DB_PASSWORD: ${{ secrets.staging_db_pass }}
          DB_DATABASE: ${{ secrets.staging_db_database }}
          DB_HOST: ${{secrets.staging_db_host}}
          DB_PREFIX: ${{ secrets.staging_db_prefix }}
          DB_TEST: ${{ secrets.staging_db_test }}
        working-directory: server

      - name: 📂 Sync Server
        uses: SamKirkland/FTP-Deploy-Action@4.1.0
        with:
          password: ${{ secrets.server_ftppass_staging }}
          server: ${{ secrets.server_ftpserver_staging }}
          username: ${{ secrets.server_ftpuser_staging }}
          local-dir: ./server/
          server-dir: list-api-staging.quickdash.co.uk/app/
          exclude: "[**/.git*/**, **/node_modules/**, **/dist/]"
